<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ trip.name }}</title>
    <!-- Flowbite & Tailwind -->
    <link href="https://cdn.jsdelivr.net/npm/flowbite@4.0.1/dist/flowbite.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/leoanangmh/flexidatepicker@1.1.5/dist/flexidatepicker.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  </head>
  <body class="min-h-screen bg-white text-gray-900">
    <main class="max-w-3xl mx-auto px-6 py-12 space-y-8">
      <h1 class="text-3xl font-bold">{{ trip.name }}</h1>
      {% if trip.creator %}
      <p class="text-gray-600 mb-4">{{ trip.creator }} invite(s) you to plan a trip.</p>
      {% endif %}

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="space-y-2">
            {% for category, message in messages %}
              <div class="p-3 rounded border {{ 'border-red-400 bg-red-50 text-red-800' if category=='error' else 'border-green-400 bg-green-50 text-green-800' }}">
                {{ message }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <!-- Share link -->
      <section class="space-y-2">
        <h2 class="text-xl font-semibold">Share this trip</h2>
        <div class="flex items-center gap-2">
          <input id="share-link" type="text" value="{{ share_url }}" readonly
                 class="flex-grow p-2 border border-gray-300 rounded" />
          <button type="button" onclick="copyLink()"
                  class="px-3 py-2 text-white bg-blue-600 rounded hover:bg-blue-700">Copy Link</button>
        </div>
      </section>

      <form method="post" class="space-y-8">
        <!-- Location selection -->
        {% if allowed_locations|length > 1 %}
        <section class="space-y-4">
          <h2 class="text-xl font-semibold">Choose Destination</h2>
          <div class="grid grid-cols-2 md:grid-cols-2 gap-4">
            {% for loc in allowed_locations %}
            <label class="cursor-pointer block">
              <input type="radio" name="location" value="{{ loc.code }}" class="hidden peer" required>
              <div class="border border-gray-300 rounded-lg overflow-hidden transition peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:border-gray-900">
                <iframe src="{{ url_for('static', filename=loc.src) }}"
                        title="{{ loc.alt }}" class="w-full h-40 md:h-48" frameborder="0" scrolling="no"></iframe>
                <div class="p-2 text-center text-sm font-medium">{{ loc.name }}</div>
              </div>
            </label>
            {% endfor %}
          </div>
        </section>
        {% else %}
        <!-- Still show the destination as a map card, but make it non-selectable -->
        <input type="hidden" name="location" value="{{ allowed_locations[0].code }}">
        <section class="space-y-4">
          <h2 class="text-xl font-semibold">Destination</h2>
          <div class="border border-gray-300 rounded-lg overflow-hidden">
            <iframe src="{{ url_for('static', filename=allowed_locations[0].src) }}"
                    title="{{ allowed_locations[0].alt }}" class="w-full h-56 md:h-72" frameborder="0" scrolling="no"></iframe>
            <div class="p-2 text-center text-sm font-medium">{{ allowed_locations[0].name }}</div>
          </div>
        </section>
        {% endif %}

        <!-- Duration selection -->
        {% if allowed_durations|length > 1 %}
        <section class="space-y-4">
          <h2 class="text-xl font-semibold">Choose Duration</h2>
          <div class="grid grid-cols-3 gap-4">
            {% for dur in allowed_durations %}
            <label class="duration-item cursor-pointer">
              <input type="radio" name="duration" value="{{ dur }}" class="hidden peer" required>
              <div
                class="aspect-square border border-gray-300 rounded-lg flex items-center justify-center transition peer-checked:border-blue-500 peer-checked:bg-blue-100 hover:border-gray-900">
                {{ dur }}
              </div>
            </label>
            {% endfor %}
          </div>
        </section>
        {% else %}
        <!-- Show all durations but lock the choice that was already fixed during trip creation -->
        <input type="hidden" name="duration" value="{{ allowed_durations[0] }}">
        <section class="space-y-4">
          <h2 class="text-xl font-semibold">Duration</h2>
          <p class="text-sm text-gray-500">Duration was already decided when the trip was created.</p>
          <div class="grid grid-cols-3 gap-4">
            {% for dur in all_durations %}
            <label class="duration-item block">
              <input type="radio" name="duration_locked" value="{{ dur }}" class="hidden peer" {% if dur==allowed_durations[0] %}checked{% endif %} disabled>
              <div
                class="aspect-square border border-gray-300 rounded-lg flex items-center justify-center transition
                       {% if dur==allowed_durations[0] %}border-blue-500 bg-blue-100{% else %}opacity-50{% endif %}">
                {{ dur }}
              </div>
            </label>
            {% endfor %}
          </div>
        </section>
        {% endif %}

        <!-- Season selection -->
        {% if allowed_seasons|length > 1 %}
        <section class="space-y-4">
          <h2 class="text-xl font-semibold">Preferred Seasons</h2>
          <p class="text-sm text-gray-500">You can pick multiple seasons.  Your choice will restrict the available dates below.</p>
          <div class="grid grid-cols-4 gap-4">
            {% for season in allowed_seasons %}
            <label class="cursor-pointer">
              <input type="checkbox" name="seasons" value="{{ season.name }}" class="hidden peer">
              <div class="border border-gray-300 rounded-lg p-3 flex flex-col items-center gap-2 transition hover:border-gray-900 peer-checked:border-blue-500 peer-checked:bg-blue-100">
                <img src="{{ url_for('static', filename=season.image) }}" alt="{{ season.name }}" class="w-16 h-16 object-contain" />
                <span class="text-sm font-medium">{{ season.name }}</span>
              </div>
            </label>
            {% endfor %}
          </div>
        </section>
        {% else %}
        <input type="hidden" name="seasons" value="{{ allowed_seasons[0].name }}">
        <p class="text-gray-700"><span class="font-medium">Season:</span> {{ allowed_seasons[0].name }}</p>
        {% endif %}

        <!-- Dates picker -->
        <section class="space-y-4">
          <h2 class="text-xl font-semibold">Available Dates</h2>
          <p class="text-sm text-gray-500">Select one or more dates for the trip.  The date picker will disable days outside of the chosen seasons.</p>
          <div class="relative max-w-sm">
            <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
              <svg class="w-4 h-4 text-body" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 10h16m-8-3V4M7 7V4m10 3V4M5 20h14a1 1 0 0 0 1-1V7a1 1 0 0 0-1-1H5a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1Zm3-7h.01v.01H8V13Zm4 0h.01v.01H12V13Zm4 0h.01v.01H16V13Zm-8 4h.01v.01H8V17Zm4 0h.01v.01H12V17Zm4 0h.01v.01H16V17Z"/>
              </svg>
            </div>
            <input id="date-picker" name="dates" type="text" placeholder="Select date(s)" readonly
                   class="block w-full ps-9 pe-3 py-2.5 bg-neutral-secondary-medium border border-default-medium text-heading text-sm rounded-base focus:ring-brand focus:border-brand shadow-xs" />
          </div>
        </section>

        <!-- Participant name -->
        <section class="space-y-4">
          <h2 class="text-xl font-semibold">Your Name (optional)</h2>
          <input type="text" name="participant_name" placeholder="Enter your name" class="w-full p-2.5 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500" />
        </section>

        <button type="submit" class="w-full px-4 py-2 font-medium text-white bg-blue-600 rounded hover:bg-blue-700">
          Submit Preferences
        </button>
      </form>

      <!-- Response summary with improved visualisation -->
      {% if trip.responses %}
      <section class="space-y-4">
        <h2 class="text-xl font-semibold">Current Responses</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <!-- Destinations -->
          <div>
            <h3 class="font-medium mb-2">Destinations</h3>
            {% for code, count in sorted_locations %}
            <div class="mb-2">
              <div class="flex items-center justify-between">
                <span class="text-sm">{{ location_details[code].name if code in location_details else code }}</span>
                <span class="text-xs font-semibold">{{ count }}</span>
              </div>
              <div class="w-full h-2 bg-gray-200 rounded">
                <div class="h-2 bg-blue-500 rounded" style="width: {{ (count / (totals.locations or 1) * 100) | round(2) }}%"></div>
              </div>
            </div>
            {% endfor %}
          </div>
          <!-- Durations -->
          <div>
            <h3 class="font-medium mb-2">Durations</h3>
            {% for dur, count in sorted_durations %}
            <div class="mb-2">
              <div class="flex items-center justify-between">
                <span class="text-sm">{{ dur }}</span>
                <span class="text-xs font-semibold">{{ count }}</span>
              </div>
              <div class="w-full h-2 bg-gray-200 rounded">
                <div class="h-2 bg-green-500 rounded" style="width: {{ (count / (totals.durations or 1) * 100) | round(2) }}%"></div>
              </div>
            </div>
            {% endfor %}
          </div>
          <!-- Seasons -->
          <div>
            <h3 class="font-medium mb-2">Seasons</h3>
            {% for season, count in sorted_seasons %}
            <div class="mb-2">
              <div class="flex items-center justify-between">
                <span class="text-sm">{{ season }}</span>
                <span class="text-xs font-semibold">{{ count }}</span>
              </div>
              <div class="w-full h-2 bg-gray-200 rounded">
                <div class="h-2 bg-purple-500 rounded" style="width: {{ (count / (totals.seasons or 1) * 100) | round(2) }}%"></div>
              </div>
            </div>
            {% endfor %}
          </div>
          <!-- Months -->
          <div>
            <h3 class="font-medium mb-2">Months</h3>
            {% for month, count in sorted_months %}
            <div class="mb-2">
              <div class="flex items-center justify-between">
                <span class="text-sm">{{ month }}</span>
                <span class="text-xs font-semibold">{{ count }}</span>
              </div>
              <div class="w-full h-2 bg-gray-200 rounded">
                <div class="h-2 bg-red-500 rounded" style="width: {{ (count / (totals.months or 1) * 100) | round(2) }}%"></div>
              </div>
            </div>
            {% endfor %}
          </div>
          <!-- Dates -->
          <div>
            <h3 class="font-medium mb-2">Dates</h3>
            {% for date_item in sorted_dates_top %}
            {% set date_str = date_item[0] %}
            {% set count = date_item[1] %}
            <div class="mb-2">
              <div class="flex items-center justify-between">
                <span class="text-sm">{{ date_str }}</span>
                <span class="text-xs font-semibold">{{ count }}</span>
              </div>
              <div class="w-full h-2 bg-gray-200 rounded">
                <div class="h-2 bg-yellow-500 rounded" style="width: {{ (count / (totals.dates or 1) * 100) | round(2) }}%"></div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        <!-- Highlight the most popular choices -->
        <div class="mt-4 space-y-1 text-sm">
          {% if sorted_locations %}
          <p><span class="font-medium">Most popular destination:</span> {{ location_details[sorted_locations[0][0]].name if sorted_locations[0][0] in location_details else sorted_locations[0][0] }}</p>
          {% endif %}
          {% if sorted_durations %}
          <p><span class="font-medium">Most popular duration:</span> {{ sorted_durations[0][0] }}</p>
          {% endif %}
          {% if sorted_seasons %}
          <p><span class="font-medium">Most popular season:</span> {{ sorted_seasons[0][0] }}</p>
          {% endif %}
          {% if sorted_months %}
          <p><span class="font-medium">Best month:</span> {{ sorted_months[0][0] }}</p>
          {% endif %}
          {% if sorted_dates_top %}
          <p><span class="font-medium">Best date:</span> {{ sorted_dates_top[0][0] }}</p>
          {% endif %}
        </div>
      </section>
      {% endif %}
    </main>

    <script src="https://cdn.jsdelivr.net/npm/flowbite@4.0.1/dist/flowbite.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flowbite-datepicker@1.3.0/dist/datepicker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/leoanangmh/flexidatepicker@1.1.5/dist/flexidatepicker.umd.min.js"></script>
    <script>
      // Copy the share link to the clipboard
      function copyLink() {
        const input = document.getElementById('share-link');
        input.select();
        input.setSelectionRange(0, 99999); // For mobile devices
        navigator.clipboard.writeText(input.value).then(() => {
          // Show a simple toast via alert; in a full app you'd use
          // proper toast notifications.
          alert('Link copied to clipboard');
        });
      }

      // Initialise FlexiDatepicker and restrict days to selected seasons
      document.addEventListener("DOMContentLoaded", () => {
        // --- Date helpers (use local time to avoid off-by-one issues) ---
        function pad2(n) { return String(n).padStart(2, "0"); }
        function toLocalISO(d) {
          return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
        }
        function parseISODate(iso) {
          // iso in yyyy-mm-dd
          const [y, m, day] = iso.split("-").map(Number);
          return new Date(y, m - 1, day);
        }
        // Generate an array of local YYYY-MM-DD strings between start and end (inclusive)
        function generateDates(startISO, endISO) {
          const s = parseISODate(startISO);
          const e = parseISODate(endISO);
          const dates = [];
          for (let d = new Date(s); d <= e; d.setDate(d.getDate() + 1)) {
            dates.push(toLocalISO(d));
          }
          return dates;
        }

        // Build season date lists for multiple years so users can pick (e.g.) July 2026.
        const currentYear = new Date().getFullYear();
        // Offer a rolling multi-year window.
        const startYear = currentYear;
        const endYear = currentYear + 4; // current year + 4 years

        function buildSeasonDates(seasonName) {
          let out = [];
          for (let y = startYear; y <= endYear; y++) {
            if (seasonName === "Spring") out = out.concat(generateDates(`${y}-03-01`, `${y}-05-31`));
            if (seasonName === "Summer") out = out.concat(generateDates(`${y}-06-01`, `${y}-08-31`));
            if (seasonName === "Fall")   out = out.concat(generateDates(`${y}-09-01`, `${y}-11-30`));
            if (seasonName === "Winter") {
              // Winter spans year boundaries: Dec -> Mar
              out = out.concat(generateDates(`${y}-12-01`, `${y}-12-31`));
              if (y + 1 <= endYear) out = out.concat(generateDates(`${y + 1}-01-01`, `${y + 1}-03-31`));
            }
          }
          return out;
        }

        const seasonDates = {
          "Winter": buildSeasonDates("Winter"),
          "Spring": buildSeasonDates("Spring"),
          "Summer": buildSeasonDates("Summer"),
          "Fall":   buildSeasonDates("Fall"),
        };

        // Initialise the datepicker with multiple selection mode.  We attach
        // an onSelectionChange callback to ensure the input's value always
        // contains a commaâ€‘separated list of selected dates instead of the
        // default "X Dates Selected" string.  This allows the server to
        // correctly parse the selected dates from the form submission.
        const fp = new FlexiDatepicker("#date-picker", {
          mode: "multiple",
          dateFormat: "yyyy-MM-dd",
          disabledDates: [],
          // When the selection changes, update the input value with actual
          // ISO date strings separated by commas.
          onSelectionChange: ({ dates }) => {
            // dates is an array of strings (yyyy-mm-dd) in arbitrary order
            const sortedDates = [...dates].sort();
            const input = document.getElementById("date-picker");
            input.value = sortedDates.join(",");
          },
        });

        // Get the checkboxes (if more than one season is selectable) and
        // compute the allowed and disabled dates based on selection.  Because
        // FlexiDatepicker does not expose a public method to update
        // disabled dates after initialisation, we update the internal
        // configuration and trigger a re-render of the calendar.
        const seasonCheckboxes = document.querySelectorAll('input[name="seasons"]');
        function updateDisabledDates() {
          // Determine which seasons are currently selected.  If no
          // checkboxes are checked we treat that as selecting all allowed
          // seasons, so we simply leave all dates enabled.
          const selectedSeasons = Array.from(seasonCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);

          let allowedDates = [];
          if (selectedSeasons.length > 0) {
            selectedSeasons.forEach(season => {
              allowedDates = allowedDates.concat(seasonDates[season] || []);
            });
          } else {
            // When no seasons are selected, allow all seasons defined for this trip.
            const allSeasonNames = [
              {% for s in allowed_seasons %}'{{ s.name }}'{% if not loop.last %}, {% endif %}{% endfor %}
            ];
            allSeasonNames.forEach(season => {
              allowedDates = allowedDates.concat(seasonDates[season] || []);
            });
          }

          // Build a list of all dates in our considered range.  We include
          // two years to cover winter crossing into the next year.
          const startDate = new Date(startYear, 0, 1);
          const endDate = new Date(endYear, 11, 31);
          const allDates = [];
          for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            allDates.push(toLocalISO(d));
          }

          // Disabled dates are any date not in the allowed list
          const disabled = allDates.filter(d => !allowedDates.includes(d));

          // Update the internal disabledDates config and re-render the calendar
          fp.options.disabledDates = disabled;
          // Remove any currently selected dates that are now disabled
          fp.selectedDates = fp.selectedDates.filter(d => !disabled.includes(d));
          // Refresh the calendar to reflect the new disabled dates and
          // update the input value and external display
          fp.renderCalendar();
          fp.updateSelectedDisplay && fp.updateSelectedDisplay();
        }

        if (seasonCheckboxes.length > 0) {
          seasonCheckboxes.forEach(cb => cb.addEventListener("change", updateDisabledDates));
          // Initial call to set disabled dates based on any prechecked boxes
          updateDisabledDates();
        } else {
          // When there is only one allowed season, disable all dates outside of it
          const defaultSeason = "{{ allowed_seasons[0].name if allowed_seasons else '' }}";
          const allowed = seasonDates[defaultSeason] || [];
          const startDate = new Date(startYear, 0, 1);
          const endDate = new Date(endYear, 11, 31);
          const allDates = [];
          for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            allDates.push(toLocalISO(d));
          }
          const disabled = allDates.filter(d => !allowed.includes(d));
          fp.options.disabledDates = disabled;
          // We don't need to remove selectedDates here since none exist on load
          fp.renderCalendar();
        }
      });
    </script>
  </body>
</html>
